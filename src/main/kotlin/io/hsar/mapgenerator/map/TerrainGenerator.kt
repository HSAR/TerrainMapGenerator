package io.hsar.mapgenerator.map

import kotlin.math.truncate

/**
 * Reimplemented from https://myforest.uk/
 * Graham Relf, UK, 2006-2021
 */
object TerrainGenerator {
    fun generateTerrain(width: Int, height: Int): Array<DoubleArray> {
        return (0 until width).map { x ->
            (0 until height).map { y ->
                calculateHeight(x = x, y = y)
            }.toDoubleArray()
        }.toTypedArray()
    }

    private fun calculateHeight(x: Int, y: Int): Double {
        var height = 0.0
        for ((repeat_x, repeat_y) in REPEAT_PROFILES) {
            val j = (repeat_x * x + repeat_y * y) * RECIP128
            val jint = truncate(j).toInt()
            val jfrac = j - jint
            val prof0 = HEIGHT_PROFILE[jint and 0xff]
            val prof1 = HEIGHT_PROFILE[(jint + 1) and 0xff]
            height += prof0 + jfrac * (prof1 - prof0); // interpolate
        }
        return height / REPEAT_PROFILES.size
    }

    private val HEIGHT_PROFILE = arrayOf(
        0.6015625, 0.625, 0.65625, 0.6875, 0.71875, 0.75, 0.7890625, 0.8125,
        0.84375, 0.875, 0.8984375, 0.921875, 0.9375, 0.9609375, 0.984375, 1.0078125,
        1.0234375, 1.0390625, 1.046875, 1.046875, 1.0390625, 1.0390625, 1.0234375, 1.015625,
        1.0078125, 0.984375, 0.9609375, 0.953125, 0.953125, 0.953125, 0.9609375, 0.9765625,
        0.984375, 1.015625, 1.046875, 1.0703125, 1.0703125, 1.078125, 1.078125, 1.0703125,
        1.0546875, 1.0390625, 1.0078125, 0.9609375, 0.921875, 0.8671875, 0.8203125, 0.7890625,
        0.7578125, 0.7265625, 0.703125, 0.671875, 0.640625, 0.609375, 0.578125, 0.5546875,
        0.5390625, 0.5234375, 0.5234375, 0.5234375, 0.515625, 0.5234375, 0.5390625, 0.5546875,
        0.5703125, 0.578125, 0.5703125, 0.5703125, 0.5546875, 0.5390625, 0.515625, 0.484375,
        0.453125, 0.421875, 0.40625, 0.40625, 0.421875, 0.4296875, 0.453125, 0.4609375,
        0.484375, 0.4921875, 0.4921875, 0.5078125, 0.5078125, 0.5078125, 0.515625, 0.515625,
        0.5234375, 0.5390625, 0.546875, 0.5703125, 0.6015625, 0.625, 0.640625, 0.6640625,
        0.6875, 0.703125, 0.7265625, 0.7421875, 0.75, 0.75, 0.75, 0.75,
        0.7265625, 0.71875, 0.703125, 0.6640625, 0.625, 0.5859375, 0.5546875, 0.5234375,
        0.4921875, 0.46875, 0.453125, 0.4296875, 0.40625, 0.390625, 0.3671875, 0.34375,
        0.3359375, 0.3203125, 0.3125, 0.3046875, 0.28125, 0.2734375, 0.2578125, 0.25,
        0.234375, 0.21875, 0.1875, 0.15625, 0.1171875, 0.0859375, 0.0546875, 0.0234375,
        0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.015625, 0.0234375, 0.046875,
        0.0546875, 0.078125, 0.0859375, 0.1171875, 0.140625, 0.171875, 0.1875, 0.1953125,
        0.1953125, 0.203125, 0.203125, 0.1953125, 0.1953125, 0.1953125, 0.1953125, 0.1953125,
        0.203125, 0.21875, 0.2265625, 0.234375, 0.2578125, 0.28125, 0.2890625, 0.3046875, 0.3046875,
        0.3125, 0.3125, 0.3125, 0.3046875, 0.3046875, 0.3046875, 0.2890625, 0.2890625,
        0.2890625, 0.28125, 0.28125, 0.28125, 0.2734375, 0.2734375, 0.2578125, 0.2578125,
        0.25, 0.234375, 0.21875, 0.1953125, 0.15625, 0.1171875, 0.0859375, 0.078125,
        0.0703125, 0.0703125, 0.0703125, 0.0703125, 0.0859375, 0.109375, 0.1171875, 0.1328125,
        0.1328125, 0.140625, 0.140625, 0.140625, 0.140625, 0.140625, 0.140625, 0.1328125,
        0.1328125, 0.1328125, 0.1171875, 0.109375, 0.1015625, 0.0859375, 0.0859375, 0.078125,
        0.078125, 0.078125, 0.0859375, 0.1015625, 0.109375, 0.1328125, 0.15625, 0.171875,
        0.1953125, 0.21875, 0.234375, 0.2734375, 0.3046875, 0.3203125, 0.3515625, 0.390625,
        0.453125, 0.4921875, 0.5390625, 0.5703125, 0.6015625, 0.625, 0.640625, 0.65625,
        0.65625, 0.6640625, 0.6640625, 0.65625, 0.65625, 0.640625, 0.6328125, 0.625,
        0.5859375, 0.5703125, 0.5546875, 0.5546875, 0.5703125, 0.578125, 0.5859375
    )

    private val REPEAT_PROFILES = arrayOf(0 to 27, 13 to 26, 21 to 21, 22 to 11, 29 to 1)

    private val RECIP128 = 1.0 / 128.0

}